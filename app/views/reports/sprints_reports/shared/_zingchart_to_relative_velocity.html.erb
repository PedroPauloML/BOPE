<% sprint = Sprint.find(params[:sprint]) if params[:sprint].present? %>

<% if sprint.present? %>
  <% projects = Project.where(id: sprint.projects.ids).order(:description) %>

  <script>
    window.onload = function() {
      <% projects.each do |project| %>

        <% speed = [] %>

        <% expected_points = 0 %>

        <% pontos_cadastrados = 0 %>

        <% sprint.activities.where(project_id: project.id).each do |a| %>

          <% pontos_cadastrados += a.pontos_cadastrados %>

        <% end %>

        <% Burndown.where(project_id: project.id, week_id: sprint.weeks.order(:description).ids).each do |b| %>

          <% speed << (b.points_made / pontos_cadastrados).round(1) %>

        <% end %>

        zingchart.render({
          id: "chart_<%= project.id %>",
          data: {
            "type": "line",
            "title": {
              "text": "Velocidade"
            },
            "plotarea": {
              "margin-top": "10%"
            },
            "plot": {
              "value-box": {
                "text": "%v%"
              }
            },
            "scale-x": {
              "labels": <%= raw (sprint.weeks
                                 .order(:description)
                                 .collect { |w| w.description }) %>
            },
            "scale-y": {
              "values": "0:<%= speed.max + 2 %>:2",
              "label": {
                "text": "Pontos"
              }
            },
            "series": [
              <% w_count = 1 %>
              <% speed.each do |s| %>
                {
                  "values": <%= [s] %>,
                  "text": "Semana <%= w_count %>"
                }
                <% w_count += 1 %>
              <% end %>
            ]
          }
        });
      <% end %>
    };
  </script>
<% end %>