<script>
  window.onload = function() {

    <% hr_users = [] %>
    <% sprint = Sprint.find(params[:sprint]) if params[:sprint].present? %>

    <% if sprint.present? %>

      <% Project.all.order(:description).each do |project| %>

        <%# VELOCIDADE RELATIVA %>
        <% speed = [] %>
        <% expected_points = 0 %>
        <% pontos_cadastrados = 0 %>

        <% sprint.activities.where(project_id: project.id).each do |a| %>
          <% pontos_cadastrados += a.pontos_cadastrados %>
        <% end %>

        <% Burndown.where(project_id: project.id, week_id: sprint.weeks.order(:description).ids).each do |b| %>
          <% speed << (b.points_made / pontos_cadastrados).round(1) %>
        <% end %>

        <%# DEDICAÇÃO RELATIVA %>
        <% relative_dedication = [] %>
        <% sprint.weeks.order(:description).each do |w| %>

          <% dedication = [] %>

          <% project.team.users.joins(:user_profile).order("user_profiles.name").each do |u| %>

            <% hours_performed = 0 %>

            <% w.hours_registries.where(user_id: u.id).each do |hr| %>
              <% hours_performed += hr.hours_performed %>
            <% end %>

            <% dedication << ((hours_performed * 100) /
                          ((w.expected_hours.to_f * 3600) *
                            w.hours_registries.where(user_id: u.id).count)
                         ).round(1) %>
          <% end %>

          <% avg_lab = 0 %>
          <% dedication.each do |v| %>
            <% avg_lab += v %>
          <% end %>
          <% dedication << (avg_lab / dedication.count).round(1) %>

          <% relative_dedication = dedication.last %>
        <% end %>

        <%# PRODUTIVIDADE RELATIVA %>
        <% relative_productivity = [] %>
        <% x = sprint.weeks.count - 1 %>
        <%# (0..x).each do |i| %>
          <%# relative_productivity << speed[i] / relative_dedication[i] %>
        <%# end %>

        zingchart.render({
          id: "chart_<%= project.id %>",
          data: {
            "type": "line",
            "title": {
              "text": "Produtividade Relativa"
            },
            "plotarea": {
              "margin-top": "10%",
            },
            "plot": {
              "value-box": {
                "text":"%v%",
                "padding-bottom": "5px"
              }
            },
            "scale-x": {
              "labels": <%= raw sprint.weeks.order(:description).collect { |w| w.description } %>,
              "item": {
                "font-size": "10pt",
                "max-chars": 15,
              }
            },
            "scale-y": {
              "values": "0:100<%#= relative_productivity.max + 50 %>:50",
              "format":"%v%"
            },
            "series": [
              {
                "values": <%= speed %>,
              }
            ]
          }
        });

      <% end %>

    <% end %>
  };
</script>